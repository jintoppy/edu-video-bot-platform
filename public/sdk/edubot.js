"use strict";var EduBot=(()=>{var a=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var O=(s,e,t)=>e in s?a(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var A=(s,e)=>{for(var t in e)a(s,t,{get:e[t],enumerable:!0})},R=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of C(e))!S.call(s,n)&&n!==t&&a(s,n,{get:()=>e[n],enumerable:!(i=E(e,n))||i.enumerable});return s};var L=s=>R(a({},"__esModule",{value:!0}),s);var r=(s,e,t)=>O(s,typeof e!="symbol"?e+"":e,t);var T={};A(T,{EduBot:()=>d});var f="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var y=(s=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(s|=0));for(;s--;)e+=f[t[s]&63];return e};var c=class{constructor(e,t="http://localhost:3000"){r(this,"apiKey");r(this,"baseUrl");this.apiKey=e,this.baseUrl=t}async request(e,t={}){try{let i=await fetch(`${this.baseUrl}${e}`,{...t,headers:{"Content-Type":"application/json","X-API-Key":this.apiKey,...t.headers}}),n=await i.json();if(!i.ok)throw{code:n.error?.code||"UNKNOWN_ERROR",message:n.error?.message||"An unknown error occurred"};return{data:n}}catch(i){return console.error("API Request Error:",i),{error:{code:i.code||"REQUEST_FAILED",message:i.message||"Failed to complete the request"}}}}async initializeChat(e={}){return this.request("/api/v1/sdk/chat/init",{method:"POST",body:JSON.stringify({programId:e.programId,metadata:e.metadata,domain:window.location.hostname})})}async sendMessage(e,t,i){let n=await this.request("/api/v1/sdk/chat/message",{method:"POST",body:JSON.stringify({sessionId:e,message:t,metadata:i})});if(n.error)throw new Error(n.error.message);if(!n.data)throw new Error("No data received from server");return n.data}async endSession(e){return this.request(`/api/v1/sdk/chat/${e}/end`,{method:"POST"})}async saveSessionState(e){return this.request(`/api/v1/sdk/chat/${e}/state`,{method:"POST",body:JSON.stringify({sessionId:e,lastActive:new Date().toISOString()})})}async validateSession(e){return this.request(`/api/v1/sdk/chat/${e}/validate`,{method:"GET"})}async getSessionHistory(e,t=50,i){let n=new URLSearchParams({limit:t.toString(),...i&&{before:i}});return this.request(`/api/v1/sdk/chat/${e}/history?${n}`,{method:"GET"})}async getOrgSettings(e){return this.request("/api/v1/sdk/org-settings",{method:"GET",headers:{"X-API-Key":e}})}async*streamChat(e,t,i,n){try{let o=await fetch(`${this.baseUrl}/api/v1/sdk/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.apiKey},body:JSON.stringify({message:e,sessionId:t,previousMessages:i,metadata:n})});if(!o.ok)throw new Error("Stream request failed");let p=o.body?.getReader();if(!p)throw new Error("No reader available");let b=new TextDecoder,h="";for(;;){let{done:v,value:I}=await p.read();if(v)break;h+=b.decode(I,{stream:!0});let m=h.split(`
`);h=m.pop()||"";for(let g of m)if(g.trim())try{yield JSON.parse(g)}catch(u){console.error("Error parsing SSE data:",u)}}}catch(o){throw console.error("Stream error:",o),o}}},l=null,w=(s,e)=>(l||(l=new c(s,e)),l);var d=class{constructor(e){r(this,"api");r(this,"container",null);r(this,"iframe",null);r(this,"initialized",!1);r(this,"sessionId",null);r(this,"widgetMode",!1);r(this,"options",{});r(this,"config");r(this,"widgetOptions",null);r(this,"eventListeners",{});this.config={baseUrl:"http://localhost:3000",...e},this.api=w(e.apiKey,e.baseUrl),window.addEventListener("message",this.handleIframeMessage.bind(this)),window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this))}createIframe(e){if(!this.container)return;this.iframe=document.createElement("iframe");let t=new URLSearchParams({apiKey:this.config.apiKey,sessionId:this.sessionId||"",mode:this.widgetMode?"widget":"inline",...this.options.programId&&{programId:this.options.programId}});this.widgetMode&&this.widgetOptions?.theme&&(t.append("primaryColor",this.widgetOptions.theme.primaryColor||""),t.append("fontFamily",this.widgetOptions.theme.fontFamily||"")),this.iframe.src=`${this.config.baseUrl}/sdk/embedded-chat?${t.toString()}`,this.iframe.className=this.widgetMode?"edubot-widget-iframe":"edubot-iframe",this.iframe.sandbox.add("allow-same-origin"),this.iframe.sandbox.add("allow-scripts"),this.iframe.sandbox.add("allow-forms"),this.iframe.sandbox.add("allow-popups"),this.iframe.allow="microphone; camera",this.iframe.style.border="none",this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.borderRadius=this.widgetMode?"12px":"0",this.container.appendChild(this.iframe),this.iframe.onload=()=>{setTimeout(()=>{this.iframe?.contentWindow&&(console.log("Sending CHAT_INITIALIZED to iframe"),this.iframe.contentWindow.postMessage({type:"CHAT_INITIALIZED",payload:{sessionId:this.sessionId,settings:{...this.widgetOptions,...e?.settings||{}},...this.options}},"*"))},100)}}handleIframeMessage(e){try{if(!this.iframe||e.source!==this.iframe.contentWindow)return;if(this.iframe&&e.source===this.iframe.contentWindow){let t=e.data;switch(t.type){case"CHAT_INITIALIZED":this.sessionId=t.payload.data?.sessionId??y(),this.emit("chatInitialized",t.payload);break;case"MESSAGE_SENT":this.emit("messageSent",t.payload);break;case"MESSAGE_RECEIVED":this.emit("messageReceived",t.payload);break;case"SESSION_ENDED":this.sessionId=null,this.emit("sessionEnded",t.payload);break;case"ERROR":console.error("EduBot Error:",t.payload.message),this.emit("error",t.payload);break}}}catch(t){this.emit("error",{message:"Failed to process iframe message",error:t})}}handleBeforeUnload(){this.sessionId&&this.api.saveSessionState(this.sessionId).catch(console.error)}init(){if(this.initialized)return;this.container=document.createElement("div"),this.container.id="edubot-container",document.body.appendChild(this.container);let e=document.createElement("link");e.rel="stylesheet",e.href=`${this.config.baseUrl}/sdk/styles/embedded.css`,document.head.appendChild(e),this.initialized=!0}initWidget(e={}){let t={greeting:"\u{1F44B} Hi there! How can we help you today?",autoOpen:!1,delay:1e3,title:"Student Counseling",subtitle:"Typically replies within an hour",position:"bottom-right"};this.widgetOptions={...t,...e},this.widgetMode=!0,this.initialized||this.init(),this.container&&(this.container.classList.add("edubot-widget-mode"),this.container.classList.add(`edubot-widget-${this.widgetOptions.position}`),this.widgetOptions.theme&&(this.container.style.setProperty("--edubot-primary",this.widgetOptions.theme?.primaryColor??"#3B82F6"),this.container.style.setProperty("--edubot-font-family",this.widgetOptions.theme?.fontFamily??"Inter"))),this.createWidgetButton(),this.createGreetingBubble(),this.widgetOptions.autoOpen&&setTimeout(()=>{this.startChat()},this.widgetOptions.delay)}initStateManagement(){let e=this.config.stateSaveInterval||3e4;setInterval(()=>{this.sessionId&&this.api.saveSessionState(this.sessionId).catch(t=>this.emit("error",{message:"Failed to save state",error:t}))},e)}createWidgetButton(){let e=document.createElement("button");e.className="edubot-widget-button",e.innerHTML=`
      <div class="edubot-widget-button-closed">
        <div class="edubot-widget-icon">\u{1F4AC}</div>
      </div>
      <div class="edubot-widget-button-opened">
        <div class="edubot-widget-close">\xD7</div>
      </div>
    `,e.addEventListener("click",()=>{this.sessionId?this.toggleChat():this.startChat()}),this.container?.appendChild(e)}createGreetingBubble(){if(!this.widgetOptions?.greeting)return;let e=document.createElement("div");e.className="edubot-widget-greeting",e.innerHTML=`
      <div class="edubot-widget-greeting-text">${this.widgetOptions.greeting}</div>
      <div class="edubot-widget-greeting-close">\xD7</div>
    `,this.container?.appendChild(e),setTimeout(()=>{e.classList.add("edubot-widget-greeting-visible")},this.widgetOptions.delay),e.querySelector(".edubot-widget-greeting-close")?.addEventListener("click",i=>{i.stopPropagation(),e.remove()}),e.addEventListener("click",()=>{e.remove(),this.startChat()})}toggleChat(){if(this.iframe){let e=this.iframe.style.display!=="none";this.iframe.style.display=e?"none":"block",this.container?.querySelector(".edubot-widget-button")?.classList.toggle("edubot-widget-button-active",!e)}}async startChat(e={}){this.options={...this.options,...e},this.initialized||this.init();try{let t=await this.api.initializeChat(this.options);if(t.error)throw new Error(t.error.message);t.data&&t.data.data?.sessionId&&(this.sessionId=t.data.data?.sessionId),this.createIframe(t.data?.data??{settings:{features:{audio:!1,video:!1}},theme:{accentColor:"#6366F1",fontFamily:"Inter",primaryColor:"#3B82F6",secondaryColor:"#10B981"}}),this.widgetMode&&this.container?.querySelector(".edubot-widget-button")?.classList.add("edubot-widget-button-active")}catch(t){console.error("Failed to start chat:",t),this.emit("error",{message:"Failed to start chat",error:t})}}async endChat(){if(this.sessionId)try{await this.api.endSession(this.sessionId),this.sessionId=null,this.iframe&&(this.iframe.remove(),this.iframe=null),this.widgetMode&&this.container?.querySelector(".edubot-widget-button")?.classList.remove("edubot-widget-button-active"),this.emit("sessionEnded",{sessionId:this.sessionId})}catch(e){console.error("Failed to end chat:",e),this.emit("error",{message:"Failed to end chat",error:e})}}on(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}off(e,t){this.eventListeners[e]&&(this.eventListeners[e]=this.eventListeners[e].filter(i=>i!==t))}emit(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(i=>i(t))}isActive(){return!!this.sessionId}getSessionId(){return this.sessionId}destroy(){this.sessionId&&this.endChat(),this.container&&(this.container.remove(),this.container=null),window.removeEventListener("message",this.handleIframeMessage),window.removeEventListener("beforeunload",this.handleBeforeUnload),this.initialized=!1,this.widgetMode=!1,this.eventListeners={}}};window.EduBot=d;return L(T);})();
window.EduBot = EduBot.EduBot;
